
// Country flag definitions with local image paths
export const FLAGS = {
  usa: { name: 'United States', image: '/flags/usa.png', anthem: '/anthems/usa.mp3', capital: 'Washington, D.C.', population: '331M', gdp: '$23.3T', timezone: 'America/New_York', dacUrl: 'https://esta.cbp.dhs.gov/' },
  uk: { name: 'United Kingdom', image: '/flags/uk.png', anthem: '/anthems/uk.mp3', capital: 'London', population: '67M', gdp: '$3.1T', timezone: 'Europe/London', dacUrl: null },
  japan: { name: 'Japan', image: '/flags/japan.png', anthem: '/anthems/japan.mp3', capital: 'Tokyo', population: '125M', gdp: '$4.9T', timezone: 'Asia/Tokyo', dacUrl: 'https://www.vjw.digital.go.jp/' },
  china: { name: 'China', image: '/flags/china.png', anthem: '/anthems/china.mp3', capital: 'Beijing', population: '1.4B', gdp: '$17.7T', timezone: 'Asia/Shanghai', dacUrl: 'https://www.visaforchina.cn/' },
  germany: { name: 'Germany', image: '/flags/germany.png', anthem: '/anthems/germany.mp3', capital: 'Berlin', population: '83M', gdp: '$4.2T', timezone: 'Europe/Berlin' },
  france: { name: 'France', image: '/flags/france.png', anthem: '/anthems/france.mp3', capital: 'Paris', population: '67M', gdp: '$2.9T', timezone: 'Europe/Paris' },
  italy: { name: 'Italy', image: '/flags/italy.png', anthem: '/anthems/italy.mp3', capital: 'Rome', population: '59M', gdp: '$2.1T', timezone: 'Europe/Rome' },
  india: { name: 'India', image: '/flags/india.png', anthem: '/anthems/india.mp3', capital: 'New Delhi', population: '1.4B', gdp: '$3.1T', timezone: 'Asia/Kolkata', dacUrl: 'https://indianvisaonline.gov.in/evisa/tvoa.html' },
  brazil: { name: 'Brazil', image: '/flags/brazil.png', anthem: '/anthems/brazil.mp3', capital: 'BrasÃ­lia', population: '214M', gdp: '$1.6T', timezone: 'America/Sao_Paulo' },
  canada: { name: 'Canada', image: '/flags/canada.png', anthem: '/anthems/canada.mp3', capital: 'Ottawa', population: '38M', gdp: '$2.0T', timezone: 'America/Toronto', dacUrl: 'https://www.canada.ca/en/immigration-refugees-citizenship/services/visit-canada/eta.html' },
  australia: { name: 'Australia', image: '/flags/australia.png', anthem: '/anthems/australia.mp3', capital: 'Canberra', population: '26M', gdp: '$1.5T', timezone: 'Australia/Sydney', dacUrl: 'https://immi.homeaffairs.gov.au/visas/getting-a-visa/visa-listing/electronic-travel-authority-601' },
  south_korea: { name: 'South Korea', image: '/flags/south_korea.png', anthem: '/anthems/south_korea.mp3', capital: 'Seoul', population: '51M', gdp: '$1.8T', timezone: 'Asia/Seoul', dacUrl: 'https://www.k-eta.go.kr/' },
  russia: { name: 'Russia', image: '/flags/russia.png', anthem: '/anthems/russia.mp3', capital: 'Moscow', population: '144M', gdp: '$1.7T', timezone: 'Europe/Moscow' },
  spain: { name: 'Spain', image: '/flags/spain.png', anthem: '/anthems/spain.mp3', capital: 'Madrid', population: '47M', gdp: '$1.4T', timezone: 'Europe/Madrid', dacUrl: null },
  mexico: { name: 'Mexico', image: '/flags/mexico.png', anthem: '/anthems/mexico.mp3', capital: 'Mexico City', population: '126M', gdp: '$1.3T', timezone: 'America/Mexico_City', dacUrl: 'https://www.mexico-vistorcard.com/' },
  netherlands: { name: 'Netherlands', image: '/flags/netherlands.png', anthem: '/anthems/netherlands.mp3', capital: 'Amsterdam', population: '17M', gdp: '$1.0T', timezone: 'Europe/Amsterdam' },
  sweden: { name: 'Sweden', image: '/flags/sweden.png', anthem: '/anthems/sweden.mp3', capital: 'Stockholm', population: '10M', gdp: '$627B', timezone: 'Europe/Stockholm' },
  norway: { name: 'Norway', image: '/flags/norway.png', anthem: '/anthems/norway.mp3', capital: 'Oslo', population: '5M', gdp: '$482B', timezone: 'Europe/Oslo' },
  switzerland: { name: 'Switzerland', image: '/flags/switzerland.png', anthem: '/anthems/switzerland.mp3', capital: 'Bern', population: '8.7M', gdp: '$812B', timezone: 'Europe/Zurich' },
  singapore: { name: 'Singapore', image: '/flags/singapore.png', anthem: '/anthems/singapore.mp3', capital: 'Singapore', population: '5.4M', gdp: '$397B', timezone: 'Asia/Singapore', dacUrl: 'https://eservices.ica.gov.sg/sgarrivalcard' },
  thailand: { name: 'Thailand', image: '/flags/thailand.png', anthem: '/anthems/thailand.mp3', capital: 'Bangkok', population: '71M', gdp: '$506B', timezone: 'Asia/Bangkok', dacUrl: 'https://tdac.immigration.go.th/' },
  vietnam: { name: 'Vietnam', image: '/flags/vietnam.png', anthem: '/anthems/vietnam.mp3', capital: 'Hanoi', population: '98M', gdp: '$366B', timezone: 'Asia/Ho_Chi_Minh', dacUrl: 'https://evisa.xuatnhapcanh.gov.vn/' },
  indonesia: { name: 'Indonesia', image: '/flags/indonesia.png', anthem: '/anthems/indonesia.mp3', capital: 'Jakarta', population: '276M', gdp: '$1.1T', timezone: 'Asia/Jakarta', dacUrl: 'https://molina.imigrasi.go.id/' },
  philippines: { name: 'Philippines', image: '/flags/philippines.png', anthem: '/anthems/philippines.mp3', capital: 'Manila', population: '111M', gdp: '$394B', timezone: 'Asia/Manila', dacUrl: 'https://etravel.gov.ph/' },
  myanmar: { name: 'Myanmar', image: '/flags/myanmar.png', anthem: '/anthems/myanmar.mp3', capital: 'Naypyidaw', population: '54M', gdp: '$65B', timezone: 'Asia/Yangon' },
  turkey: { name: 'Turkey', image: '/flags/turkey.png', anthem: '/anthems/turkey.mp3', capital: 'Ankara', population: '85M', gdp: '$815B', timezone: 'Europe/Istanbul', dacUrl: 'https://www.evisa.gov.tr/' },
  israel: { name: 'Israel', image: '/flags/israel.png', anthem: '/anthems/israel.mp3', capital: 'Jerusalem', population: '9.3M', gdp: '$481B', timezone: 'Asia/Jerusalem' },
  uae: { name: 'UAE', image: '/flags/uae.png', anthem: '/anthems/uae.mp3', capital: 'Abu Dhabi', population: '9.9M', gdp: '$358B', timezone: 'Asia/Dubai' },
  pakistan: { name: 'Pakistan', image: '/flags/pakistan.png', anthem: '/anthems/pakistan.mp3', capital: 'Islamabad', population: '225M', gdp: '$346B', timezone: 'Asia/Karachi' },
  bangladesh: { name: 'Bangladesh', image: '/flags/bangladesh.png', anthem: '/anthems/bangladesh.mp3', capital: 'Dhaka', population: '166M', gdp: '$416B', timezone: 'Asia/Dhaka' },
  greece: { name: 'Greece', image: '/flags/greece.png', anthem: '/anthems/greece.mp3', capital: 'Athens', population: '10M', gdp: '$216B', timezone: 'Europe/Athens' },
  poland: { name: 'Poland', image: '/flags/poland.png', anthem: '/anthems/poland.mp3', capital: 'Warsaw', population: '38M', gdp: '$674B', timezone: 'Europe/Warsaw' },
  ukraine: { name: 'Ukraine', image: '/flags/ukraine.png', anthem: '/anthems/ukraine.mp3', capital: 'Kyiv', population: '44M', gdp: '$200B', timezone: 'Europe/Kiev' },
  argentina: { name: 'Argentina', image: '/flags/argentina.png', anthem: '/anthems/argentina.mp3', capital: 'Buenos Aires', population: '45M', gdp: '$491B', timezone: 'America/Argentina/Buenos_Aires' },
  belgium: { name: 'Belgium', image: '/flags/belgium.png', anthem: '/anthems/belgium.mp3', capital: 'Brussels', population: '11.5M', gdp: '$599B', timezone: 'Europe/Brussels' },
  ireland: { name: 'Ireland', image: '/flags/ireland.png', anthem: '/anthems/ireland.mp3', capital: 'Dublin', population: '5M', gdp: '$498B', timezone: 'Europe/Dublin' },
  austria: { name: 'Austria', image: '/flags/austria.png', anthem: '/anthems/austria.mp3', capital: 'Vienna', population: '9M', gdp: '$477B', timezone: 'Europe/Vienna' },
  denmark: { name: 'Denmark', image: '/flags/denmark.png', anthem: '/anthems/denmark.mp3', capital: 'Copenhagen', population: '5.8M', gdp: '$397B', timezone: 'Europe/Copenhagen' },
  finland: { name: 'Finland', image: '/flags/finland.png', anthem: '/anthems/finland.mp3', capital: 'Helsinki', population: '5.5M', gdp: '$299B', timezone: 'Europe/Helsinki' },
  czech: { name: 'Czech Republic', image: '/flags/czech.png', anthem: '/anthems/czech.mp3', capital: 'Prague', population: '10.7M', gdp: '$282B', timezone: 'Europe/Prague' },
  portugal: { name: 'Portugal', image: '/flags/portugal.png', anthem: '/anthems/portugal.mp3', capital: 'Lisbon', population: '10.3M', gdp: '$250B', timezone: 'Europe/Lisbon' },
  newzealand: { name: 'New Zealand', image: '/flags/newzealand.png', anthem: '/anthems/newzealand.mp3', capital: 'Wellington', population: '5M', gdp: '$250B', timezone: 'Pacific/Auckland', dacUrl: 'https://nzeta.immigration.govt.nz/' },
  southafrica: { name: 'South Africa', image: '/flags/southafrica.png', anthem: '/anthems/southafrica.mp3', capital: 'Pretoria', population: '60M', gdp: '$419B', timezone: 'Africa/Johannesburg' },
  malaysia: { name: 'Malaysia', image: '/flags/malaysia.png', anthem: '/anthems/malaysia.mp3', capital: 'Kuala Lumpur', population: '32M', gdp: '$372B', timezone: 'Asia/Kuala_Lumpur', dacUrl: 'https://imigresen-online.imi.gov.my/mdac/main' },
  saudi: { name: 'Saudi Arabia', image: '/flags/saudi.png', anthem: '/anthems/saudi.mp3', capital: 'Riyadh', population: '35M', gdp: '$833B', timezone: 'Asia/Riyadh', dacUrl: 'https://visa.visitsaudi.com/' },
}

// Helper for GitHub Pages path resolution
export const getAssetPath = (path) => {
  if (!path) return path;
  // If it's a relative-to-root path from flagData, map it to our BASE_URL
  if (path.startsWith('/')) {
    const base = import.meta.env.BASE_URL || '/';
    // Ensure base ends with / and path doesn't start with / for join
    const normalizedBase = base.endsWith('/') ? base : `${base}/`;
    return `${normalizedBase}${path.slice(1)}`;
  }
  return path;
};

// Function to load image and return ImageData
export function loadFlagImage(url) {
  const resolvedUrl = getAssetPath(url);
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = 'Anonymous';
    img.src = resolvedUrl;
    img.onload = () => {
      const canvas = document.createElement('canvas');
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0);
      try {
        const imageData = ctx.getImageData(0, 0, img.width, img.height);
        resolve(imageData);
      } catch (e) {
        reject(e);
      }
    };
    img.onerror = (e) => reject(e);
  });
}

// Helper to check if imageData is valid
export function isValidImageData(imageData) {
  return imageData && imageData.width && imageData.height && imageData.data;
}

// Core function to get color from ImageData at specific UV
export function getFlagColorFromImage(imageData, u, v) {
  if (!isValidImageData(imageData)) return [1, 1, 1]; // Default white

  // Clamp UV to 0-1
  // Direct mapping: u=0 (Left) -> x=0 (Image Left), v=0 (Top) -> y=0 (Image Top)
  const x = Math.max(0, Math.min(1, u));
  const y = Math.max(0, Math.min(1, v));

  // Map to pixel coordinates
  const px = Math.floor(x * (imageData.width - 1));
  const py = Math.floor(y * (imageData.height - 1));

  // Get index in Uint8ClampedArray (RGBA)
  const index = (py * imageData.width + px) * 4;

  const r = imageData.data[index] / 255;
  const g = imageData.data[index + 1] / 255;
  const b = imageData.data[index + 2] / 255;

  return [r, g, b];
}
